function RR_Diagram(t){this.callback=t?t:this.dummy_callback,this.css={term:"rr_terminal",nterm:"rr_nonterminal",sterm:"rr_specterminal",line:"rr_line",wrap:"rr_wrapper",vspace:10},this["class"]={box:"<div>",line:"<div>",wrap:"<div>"},this.side={left:1,right:-1}}function EBNF(t){this.rr=new RR_Diagram(t)}RR_Diagram.prototype.dummy_callback=function(t){var r=$("<h2>");r.html(t.symbol);var e=$("<p>");e.html(t.rule),$(t.target,t.targetDoc).append(r,t.diagram,e)},RR_Diagram.prototype.vbranch=function(t,r,e,i,s,a){var o=this["class"].wrap,n=this.css.line,h=$(o),l=t.outerWidth(),c=t.data("lineY"),p=0,d=!0;t.children().each(function(){var t=$(this).data("lineY"),r=$(this).position().top,a=20,c=l-40;if(p=r,d?(c=l-20,a=10,d=!1):(u=$("<div>",{"class":e}),h.append(u),u.css({height:10,top:r+t-10,left:i+10*s})),-1==s){var m=$(o,{"class":n});m.css({top:r+t,left:a,width:c}),h.append(m)}});var u=$(this["class"].wrap,{"class":r});return h.append(u),u.css({height:p-10,width:10,top:c,left:i}),a&&1==s?(u.html("&#9650;"),u.css("text-indent","5px")):a||-1!=s||u.html("&#9650;"),h},RR_Diagram.prototype.setroot=function(){var t=this.root,r=this.wrap();return this.root.append(r),this.root=r,{saved:t,node:r}},RR_Diagram.prototype.line=function(){var t=$(this["class"].line,{"class":this.css.line});return t},RR_Diagram.prototype.wrap=function(){var t=$(this["class"].wrap,{"class":this.css.wrap});return t},RR_Diagram.prototype.opt_or_loop=function(t,r){var e=this.setroot(),i=e.node,s=this.css.vspace;if(t(),i.children().length<=1)throw"d_opt: only one element specified";var a=i.children().first().data("lineY"),o=0,n=0;i.children().each(function(){var t=$(this).outerHeight();$(this).css({top:n,left:20}),n+=t+s,o=Math.max(o,$(this).outerWidth())}),i.css({width:o+40,height:n-s}),i.data("lineY",a),i.children().each(function(){var t=$(this).outerWidth();$(this).css("left",o+40-t>>1)});var h=this.vbranch(i,"rr_line_volu","rr_line_voll",0,this.side.left,r),l=this.vbranch(i,"rr_line_voru","rr_line_vorl",o+30,this.side.right,r);i.append(h),i.append(l),this.root=e.saved},RR_Diagram.prototype.d_opt=function(t){this.opt_or_loop(t,!1)},RR_Diagram.prototype.d_loop=function(t){this.opt_or_loop(t,!0)},RR_Diagram.prototype.d_box=function(t,r){var e=this.wrap();this.root.append(e);var i=this.line(),s=$(this["class"].box,{"class":r});s.html(t),e.append(i,s);var a=s.outerWidth(),o=s.outerHeight(),n=a+20;i.css({top:o>>1,width:n}),s.css({left:10}),e.data("lineY",o>>1),e.css({width:n,height:o})},RR_Diagram.prototype.d_empty=function(){var t=this.wrap();this.root.append(t),t.css({height:20,padding:5}),t.data("lineY",t.outerHeight()>>1)},RR_Diagram.prototype.d_seq=function(t){var r=this.setroot(),e=r.node,i=0,s=0,a=0;t(),e.children().each(function(){$(this).css({left:i}),i+=$(this).outerWidth(),s=Math.max(s,$(this).outerHeight()),a=Math.max(a,$(this).data("lineY"))}),e.children().each(function(){var t=$(this).data("lineY");if(t!=a){var r=a-t;$(this).css("top",a-t),s=Math.max(s,$(this).outerHeight()+r)}}),e.css({width:i,height:s}),e.data("lineY",a),this.root=r.saved},RR_Diagram.prototype.compose=function(t,r,e,i,s){var a=$("<div>");this.callback({target:t,targetDoc:r,symbol:i,rule:s,diagram:a}),this.root=a,e(),a.css({height:a.children().first().outerHeight(),width:a.children().first().outerWidth()})},EBNF.prototype.trim=function(t){return $.trim(t.replace(/[\t\n\r]+/g,""))},EBNF.prototype.p_ident=function(t){var r;return(r=/^([A-Za-z0-9][A-Za-z0-9_]*)(.*)$/.exec(t))?{ident:r[1],trailer:r[2]}:null},EBNF.prototype.p_string=function(t){return(match=/^([\"])([^\"]+)\"(.*)$/.exec(t))||(match=/^(\')([^\']+)\'(.*)$/.exec(t))||(match=/^(\?)([^\?]+)\?(.*)$/.exec(t))?{quote:match[1],string:match[2],trailer:match[3]}:null},EBNF.prototype.p_rule=function(t){t=this.trim(t);var r,e,i=[],s=!0,a="",o="";do{if(r=this.p_string(t)){var n="?"==r.quote?"sterm":"term";i.push(e={tree:'rr.d_box("'+r.string+'", rr.css.'+n+")",rule:'"'+r.string+'"',trailer:r.trailer})}else if(r=this.p_ident(t))i.push(e={tree:'rr.d_box("'+r.ident+'", rr.css.nterm)',rule:r.ident,trailer:r.trailer});else if("_"==t.substr(0,1))i.push(e={tree:"rr.d_empty()",rule:"_",trailer:t.slice(1)});else{if("("!=t.substr(0,1))throw"ENBF::p_rule : Syntax error";if(r=this.p_rule(t.slice(1)),t=this.trim(r.trailer),")"!=t.substr(0,1))throw"ENBF::p_rule: Invalid enclosed rule";t=this.trim(t.slice(1));var h="(",l=")"+t.substr(0,1),c=!0,p="";switch(l){case")*":p="rr.d_opt(function(){rr.d_empty();rr.d_loop(function(){"+r.tree+";rr.d_empty()})})";break;case")?":p="rr.d_opt(function(){"+r.tree+"; rr.d_empty()})";break;case")+":p="rr.d_loop(function(){"+r.tree+"; rr.d_empty()})";break;default:p=r.tree,l=")",c=!1}i.push(e={tree:p,rule:h+r.rule+l,trailer:c?t.slice(1):t})}switch(t=this.trim(e.trailer),a=t.substr(0,1)){case"|":case",":""==o?(o=a,t=this.trim(t.slice(1))):a==o?t=this.trim(t.slice(1)):s=!1;break;default:s=!1}}while(s);if(i.length>1){for(var d="",u="",m=0;m<i.length;m++)u+=","+i[m].tree,d+=o+i[m].rule;switch(u=u.slice(1),o){case"|":u="rr.d_opt(function(){"+u+"})";break;case",":u="rr.d_seq(function(){"+u+"})";break;default:throw"ENBF::p_rule : Unexpected error, sc="+o}return{tree:u,rule:d.slice(1),trailer:t}}if(1==i.length)return i[0];throw"ENBF::p_rule : Unexpected error"},EBNF.prototype.p_statement=function(t){var t=this.trim(t),r=this.p_ident(t);if(!r)throw"EBNF::p_statement : left side identifier expected";var t=this.trim(r.trailer);if("="==t.substr(0,1)){var e=t.slice(1),i=this.p_rule(e);return{symbol:r.ident,rule:i.rule,tree:i.tree,trailer:i.trailer}}throw"EBNF::p_statement : '=' expected"},EBNF.prototype.display=function(grammar,target,targetDoc){for(targetDoc||(targetDoc=window.document),grammar=this.trim(grammar);""!=grammar;){var res=this.p_statement(grammar),rr=this.rr;if(rr.compose(target,targetDoc,function(){eval(res.tree)},res.symbol,res.symbol+" = "+res.rule),grammar=this.trim(res.trailer),";"!=grammar.substr(0,1))throw"ENBF::parse : ';' expected";grammar=this.trim(grammar.slice(1))}};